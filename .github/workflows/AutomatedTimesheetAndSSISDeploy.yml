name: ğŸš€ Deploy SSIS Project

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted, windows]

    env:
      ISPAC_PATH: "C:\\AutomatedTimesheetProject_NS\\SSIS_Automated_Timesheet_Project\\SSIS_Automated_Timesheet_Project.ispac"

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Prepare Deployment Script
        shell: powershell
        run: |
          Write-Host "ğŸ› ï¸ Creating SQL script to deploy SSIS .ispac..."
          $sql = @"
          :setvar IspacFullPath "$env:ISPAC_PATH"
          :r C:\\AutomatedTimesheetProject_NS\\SQLScripts\\CreateTimesheetDBAndSSIS.sql
          "@
          $sql | Out-File -FilePath AutomatedTimesheetAndSSISDeploy.sql -Encoding ASCII
          Write-Host "âœ… Deployment script ready: AutomatedTimesheetAndSSISDeploy.sql"

      - name: ğŸš€ Deploy SSIS Project to SSISDB
        shell: cmd
        run: |
          echo ğŸš€ Deploying .ispac to SSISDB...
          sqlcmd -S LAPTOP-JUKB3QVS -E -i AutomatedTimesheetAndSSISDeploy.sql
          IF %ERRORLEVEL% NEQ 0 (
            echo âŒ SSIS deployment failed!
            exit /b %ERRORLEVEL%
          )
          echo âœ… SSIS project deployed successfully!

      - name: ğŸ—“ï¸ Create or Update SQL Agent Job
        shell: cmd
        run: |
          echo ğŸ—“ï¸ Creating or updating SQL Agent Job...
          sqlcmd -S LAPTOP-JUKB3QVS -E -i C:\AutomatedTimesheetProject_NS\SQLScripts\AutomatedTimesheetProject_NS_Job.sql
          IF %ERRORLEVEL% NEQ 0 (
            echo âŒ Failed to create/update Agent Job!
            exit /b %ERRORLEVEL%
          )
          echo âœ… SQL Agent Job ready!

      - name: ğŸ¯ Run SQL Agent Job
        shell: cmd
        run: |
          echo ğŸ¯ Executing SQL Agent Job: AutomatedTimesheetProject_NS_Job...
          sqlcmd -S LAPTOP-JUKB3QVS -E -Q "EXEC msdb.dbo.sp_start_job @job_name = N'AutomatedTimesheetProject_NS_Job'"
          IF %ERRORLEVEL% NEQ 0 (
            echo âŒ Job execution failed!
            exit /b %ERRORLEVEL%
          )
          echo âœ… Job started successfully!
