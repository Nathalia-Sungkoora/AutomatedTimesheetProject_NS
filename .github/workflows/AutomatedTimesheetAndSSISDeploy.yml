name: Deploy Automated Timesheet and SSIS Project

on:
  push:
    branches: [main]

jobs:
  create-db:
    name: üêß Create TimesheetDB and Tables
    runs-on: ubuntu-latest

    env:
      PINGGY_URL: ${{ secrets.PINGGY_URL }}
      SQL_USER: ${{ secrets.SQL_USER }}
      SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v4

      - name: üì• Install SQLCMD on Ubuntu
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev

      - name: üóÉÔ∏è Create TimesheetDB and Tables
        run: |
          /opt/mssql-tools/bin/sqlcmd -S $PINGGY_URL,1433 -U $SQL_USER -P $SQL_PASSWORD -i ./SQLScripts/CreateTimesheetDBAndSSIS.sql

  deploy-ssis:
    name: ü™ü Deploy SSIS Package
    runs-on: [self-hosted, windows]
    needs: create-db

    env:
      ISPAC_PATH: "C:\\AutomatedTimesheetProject_NS\\SSISAutomatedTimesheetProject\\SSIS_Automated_Timesheet_Project.ispac"

    steps:
      - name: üöÄ Checkout code
        uses: actions/checkout@v4

      - name: üìù Prepare SSIS Deploy Script
        shell: powershell
        run: |
          $sql = @"
          :setvar IspacFullPath "$env:ISPAC_PATH"
          :r C:\\AutomatedTimesheetProject_NS\\SQLScripts\\CreateTimesheetDBAndSSIS.sql
          "@
          $sql | Out-File -FilePath AutomatedTimesheetAndSSISDeploy.sql -Encoding ASCII

      - name: üì¶ Deploy SSIS to SSISDB (Windows Auth required)
        shell: cmd
        run: |
          sqlcmd -S localhost -E -i AutomatedTimesheetAndSSISDeploy.sql

  create-agent-job:
    name: üß± Create SQL Server Agent Job
    runs-on: ubuntu-latest
    needs: deploy-ssis

    env:
      PINGGY_URL: ${{ secrets.PINGGY_URL }}
      SQL_USER: ${{ secrets.SQL_USER }}
      SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v4

      - name: ‚öíÔ∏è Create SQL Agent Job
        run: |
          /opt/mssql-tools/bin/sqlcmd -S $PINGGY_URL,1433 -U $SQL_USER -P $SQL_PASSWORD -i ./SQLScripts/AutomatedTimesheetProject_NS_Job.sql

      - name: ‚ñ∂Ô∏è Run SQL Agent Job
        run: |
          /opt/mssql-tools/bin/sqlcmd -S $PINGGY_URL,1433 -U $SQL_USER -P $SQL_PASSWORD -Q "EXEC msdb.dbo.sp_start_job @job_name = N'AutomatedTimesheetProject_NS_Job'"
